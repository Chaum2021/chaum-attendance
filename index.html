
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ระบบเช็คอิน/เอาท์</title>
  <script>
    let currentLocation = { lat: null, lng: null };

    async function loadEmployeeList() {
      try {
        const res = await fetch('https://script.google.com/macros/s/AKfycbxyo3e_eVDPC6CQ-73TZBUIIygqapT-YXjaGFm9f9ene1YtbNJf_SOo2gXZ_etUscFj/exec');
        const data = await res.json();
        const select = document.getElementById('employeeSelect');
        data.forEach(emp => {
          const option = document.createElement('option');
          option.value = emp["รหัสพนักงาน"];
          option.text = emp["ชื่อ-นามสกุล"];
          select.appendChild(option);
        });
      } catch (e) {
        console.error("โหลดรายชื่อพนักงานล้มเหลว:", e);
      }
    }

    function updateLocation() {
      navigator.geolocation.getCurrentPosition(
        position => {
          currentLocation.lat = position.coords.latitude;
          currentLocation.lng = position.coords.longitude;
          document.getElementById('locationInfo').innerText = `ละติจูด: ${currentLocation.lat}, ลองจิจูด: ${currentLocation.lng}`;
        },
        error => {
          alert("ไม่สามารถดึงพิกัดได้");
        }
      );
    }

    function checkInOut(status) {
      const select = document.getElementById('employeeSelect');
      const selectedName = select.options[select.selectedIndex].text;
      const selectedId = select.value;

      const record = {
        name: selectedName,
        employeeId: selectedId,
        status: status
      };

      if (!selectedId) {
        alert("กรุณาเลือกชื่อพนักงาน");
        return;
      }

      fetch('https://script.google.com/macros/s/AKfycbxyo3e_eVDPC6CQ-73TZBUIIygqapT-YXjaGFm9f9ene1YtbNJf_SOo2gXZ_etUscFj/exec', {
        method: 'POST',
        contentType: 'application/json',
        body: JSON.stringify({
          name: record.name,
          employeeId: record.employeeId,
          status: record.status,
          lat: currentLocation.lat,
          lng: currentLocation.lng,
          address: document.getElementById('locationInfo').innerText || ''
        })
      }).then(() => {
        alert(`${status} สำเร็จ`);
      }).catch(() => {
        alert("ส่งข้อมูลล้มเหลว");
      });
    }

    window.onload = () => {
      loadEmployeeList();
      updateLocation();
    };
  </script>
</head>
<body>
  <h2>ระบบเช็คอิน / เช็คเอาท์</h2>
  <label for="employeeSelect">เลือกชื่อพนักงาน:</label>
  <select id="employeeSelect">
    <option value="">-- เลือกพนักงาน --</option>
  </select>
  <p id="locationInfo">กำลังโหลดพิกัด...</p>
  <button onclick="checkInOut('เช็คอิน')">เช็คอิน</button>
  <button onclick="checkInOut('เช็คเอาท์')">เช็คเอาท์</button>
</body>
</html>
